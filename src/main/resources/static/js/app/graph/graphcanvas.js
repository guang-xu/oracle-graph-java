let __graph_viz_data__ = {
    "nodes": [
        {
            "id": "zhouying",
            "name": "周莹",
            "role_id": 41,
            "group": 1,
            "avatar": "./img/zhouying.jpg"
        }, 
        {
            "id":"shenxingyi", 
            "name": "沈星移",  
            "role_id": 42,
            "group": 1,
            "avatar": "./img/shenxingyi.jpg"
        },
        {
            "id": "zhaobaishi",
            "name": "赵白石",
            "role_id": 44,
            "group": 1,
            "avatar": "./img/zhaobaishi.jpg"
        },
        {
            "id": "zhoulaosi",
            "name": "周老四",
            "role_id": 49,
            "group": 1,
            "avatar": "./img/zhoulaosi.jpg"
        },
        {
            "id": "wupin",
            "name": "吴聘",
            "role_id": 43,
            "group": 1,
            "avatar": "./img/wupin.jpg"
        },
        {
            "id": "shensihai",
            "name": "沈四海",
            "role_id": 50,
            "group": 1,
            "avatar": "./img/shensihai.jpg"
        },
        {
            "id": "wuweiwen",
            "name": "吴蔚文",
            "role_id": 47,
            "group": 1,
            "avatar": "./img/wuweiwen.jpg"
        },
        {
            "id": "qianhong",
            "name": "千红",
            "role_id": 51,
            "group": 1,
            "avatar": "./img/qianhong.jpg"
        },
        {
            "id": "wulian",
            "name": "吴莲",
            "role_id": 48,
            "group": 1,
            "avatar": "./img/wulian.jpg"
        },
        {
            "id": "shenyuesheng",
            "name": "沈月生",
            "role_id": 55,
            "group": 1,
            "avatar": "./img/shenyuesheng.jpg"
        },
        {
            "id": "shenlaofuren",
            "name": "沈老夫人",
            "role_id": 833,
            "group": 1,
            "avatar": "./img/shenlaofuren.png"
        },
        {
            "id": "shenfuren",
            "name": "沈夫人",
            "role_id": 832,
            "group": 1,
            "avatar": "./img/shenfuren.png"
        },
        {
            "id": "wuyu",
            "name": "吴遇",
            "role_id": 59,
            "group": 1,
            "avatar": "./img/wuyu.jpg"
        },
        {
            "id": "huyongmei",
            "name": "胡勇每",
            "role_id": 45,
            "group": 1,
            "avatar": "./img/huyongmei.jpg"
        },
        {
            "id": "dumingli",
            "name": "杜明里",
            "role_id": 46,
            "group": 1,
            "avatar": "./img/dumingli.png"
        },
        {
            "id": "wuzhe",
            "name": "吴哲",
            "role_id": 56,
            "group": 1,
            "avatar": "./img/wuzhe.jpg"
        }
    ],
    "links": [
        {
            "source": "zhouying",
            "target": "shenxingyi",
            "relation": "朋友",
            "color": "734646"
        },
        {
            "source": "zhouying",
            "target": "zhaobaishi",
            "relation": "\u670b\u53cb",
            "color": "734646"
        },
        {
            "source": "zhouying",
            "target": "zhoulaosi",
            "relation": "\u517b\u5973",
            "color": "f2826a"
        },
        {
            "source": "zhouying",
            "target": "wupin",
            "relation": "\u4ec7\u4eba",
            "color": "f2826a"
        },
        {
            "source": "zhouying",
            "target": "shensihai",
            "relation": "\u513f\u5ab3",
            "color": "e3dce3"
        },
        {
            "source": "zhouying",
            "target": "wuweiwen",
            "relation": "\u59d0\u59b9",
            "color": "88748d"
        },
        {
            "source": "zhouying",
            "target": "qianhong",
            "relation": "\u5ac2\u5b50",
            "color": ""
        },
        {
            "source": "wuzhe",
            "target": "wulian",
            "relation": "\u54e5\u54e5",
            "color": "88748d"
        },
        {
            "source": "shenxingyi",
            "target": "shenyuesheng",
            "relation": "\u5b59\u5b50",
            "color": "6681ae"
        },
        {
            "source": "shenxingyi",
            "target": "zhoulaosi",
            "relation": "\u4ec7\u4eba",
            "color": ""
        },
        {
            "source": "shenxingyi",
            "target": "wuweiwen",
            "relation": "\u60c5\u4eba",
            "color": "fcb7e9"
        },
        {
            "source": "zhoulaosi",
            "target": "wupin",
            "relation": "\u7ade\u4e89",
            "color": ""
        },

        {
            "source": "zhoulaosi",
            "target": "shenxingyi",
            "relation": "\u6c11\u4e0e\u5b98",
            "color": ""
        },
        {
            "source": "zhoulaosi",
            "target": "wuyu",
            "relation": "\u9752\u6885\u7af9\u9a6c",
            "color": ""
        },
        {
            "source": "wuyu",
            "target": "huyongmei",
            "relation": "\u6c42\u52a9",
            "color": ""
        },
        {
            "source": "wuyu",
            "target": "zhouying",
            "relation": "\u4ec7\u4eba",
            "color": ""
        },
        {
            "source": "wuyu",
            "target": "shensihai",
            "relation": "\u6c42\u52a9",
            "color": ""
        },

        {
            "source": "huyongmei",
            "target": "zhouying",
            "relation": "\u4ec7\u4eba",
            "color": ""
        },
        {
            "source": "huyongmei",
            "target": "shenxingyi",
            "relation": "\u4ec7\u4eba",
            "color": ""
        },
        {
            "source": "huyongmei",
            "target": "wupin",
            "relation": "\u5408\u4f5c",
            "color": ""
        },
        {
            "source": "huyongmei",
            "target": "wulian",
            "relation": "\u5229\u7528",
            "color": ""
        },

        {
            "source": "qianhong",
            "target": "dumingli",
            "relation": "\u5144\u59b9",
            "color": "88748d"
        },
        {
            "source": "dumingli",
            "target": 'zhouying',
            "relation": "\u5ac2\u5b50",
            "color": ""
        },

        {
            "source": "shenfuren",
            "target": "huyongmei",
            "relation": "\u88ab\u5e2e\u52a9",
            "color": ""
        },
        {
            "source": "shenlaofuren",
            "target": "shenyuesheng",
            "relation": "\u5a46\u5ab3",
            "color": "e3dce3"
        }
    ]
}

const width  = 1920;
const height = 1080;

const svg = d3.select('#graphcanvas').append('svg').attr('width',width).attr('height',height);

const defs = svg.append('defs');

const pattern = defs
                .selectAll('pattern')
                .data(__graph_viz_data__.nodes)
                .enter()
                .append('pattern')
                .attr('id',d=>'avatar_'+d.id)
                .attr('patternUnits','objectBoundingBox')
                .attr('x',0)
                .attr('y',0)
                .attr('width',1)
                .attr('height',1);

const maker  = defs
               .append('maker')
               .attr('id','maker') 
               .attr('makerWidth',10) 
               .attr('makerHeight',10) 
               .attr('refX',45+2)
               .attr('orient','auto')
               .attr('makerUntis','UserSpaceOnUse')
               .append('path')
               .attr('d','m 0 0 8 4 0 8Z')
               .attr('fill','steelblue');                

const images = pattern                
                .append('image')
                .attr('class','img_circle')
                .attr('height',90)
                .attr('width', 90)
                .attr('preserveAspectRatio','xMidYMin slice')
                .attr('href',d => d.avatar)
                .attr('src',d => d.avatar);

const avatarLabel = pattern                
                .append('rect')
                .attr('x',0)
                .attr('y',60)
                .attr('width',90)
                .attr('height',30)
                .attr('opacity','0.5');

const avatarText = pattern
                .append('text')
                .attr('class','avatarText')
                .text(d=>d.name)
                .attr('text-anchor','middle')
                .attr('fill','white')
                .attr('style','font-size:15px;')
                .attr('x',45)
                .attr('y',75);


const force = d3.forceSimulation(__graph_viz_data__.nodes)
                .force("charge", d3.forceManyBody())
                .force("link",   d3.forceLink(__graph_viz_data__.links).id(d => d.id))
                .force("center", d3.forceCenter().x(width/2).y(height/2))
                .force("collide", d3.forceCollide(60).strength(0.2).iterations(5))
                .alphaDecay(0.0228);
                      
const nodes = svg.selectAll('circle .node_cicle')
                 .data(__graph_viz_data__.nodes)
                 .enter()
                 .append('circle')
                 .attr('class','node_cicle')
                 .attr('r',45)
                 .attr('fill',d=>'url(#avatar_'+d.id+')')
                 .text(d => d.id)
                 .on('mouseover', function(d,i) {
                     highlightObject(d3.select(this),i);
                  })
                 .on('mouseout', function(d){
                     console.log(d);
                    highlightObject(d3.select(this));
                 });

const edges = svg.append('g')
                 .attr('id','edgeArea')
                 .selectAll('g')
                 .data(__graph_viz_data__.links)
                 .enter()
                 .append('g')
                 .attr('class','edge')
                 .attr('style','opacity:1;')
                 .on('mouseover',function(){
                     return d3.select(this).selectAll('path .links').attr('stroke-width',4);
                 })
                 .on('mouseout',function(){
                    return d3.select(this).selectAll('path .links').attr('stroke-width',1);
                 })

function getDis(s, t) {
    return Math.sqrt((s.x - t.x) * (s.x - t.x) + (s.y - t.y) * (s.y - t.y));
}   

const links=edges.append("path").attr("class","link")
                 .attr("d", d=> {return "M" + 30 + "," + 0 + " L" + getDis(d.source, d.target) + ",0";})
                 .style("marker-end", "url(#marker)")
                 .attr('stroke', (d)=> {
                     var str=d.color ? "#"+d.color : 'ccc' ;
                     return str;
                 })
                 .attr('stroke-width',2);            

// 求元素移动到目标位置所需要的 transform 属性值
function getTransform(source, target, _dis) {
    var r;
    if (target.x > source.x) {
        if (target.y > source.y) {
            r = Math.asin((target.y - source.y) / _dis)
        } else {
            r = Math.asin((source.y - target.y) / _dis);
            r = -r;
        }
    } else {
        if (target.y > source.y) {
            r = Math.asin((target.y - source.y) / _dis);
            r = Math.PI - r;
        } else {
            r = Math.asin((source.y - target.y) / _dis);
            r -= Math.PI;
        }
    }
    r = r * (180 / Math.PI);
    return "translate(" + source.x + "," + source.y + ")rotate(" + r + ")";
}


let dependsNode = [];
let dependsLinkAndText = [];

const highlightObject = (object,index)=>{
    
    BoldStroke(object);
    hightlightRelation(object);
}

const hightlightRelation =(index) => {
    d3.selectAll('.node_cicle').filter(function (d) {
        
    })
}

const BoldStroke = function(object){

    if(!object.attr('_cust_highligted')) {
        object.attr('_cust_highligted',true) 
        object.attr('stroke-width', '8');
        object.attr('stroke', '#a3e5f9');
    } else {
        object.attr('_cust_highligted',null);
        object.attr('stroke-width', 1);
        object.attr('stroke', '#c5dbf0'); 
    }
};



force.on('tick',function(){
    nodes.attr('cx',d => d.x)
         .attr('cy',d => d.y);

        //  links.attr("x1", function(d) { return d.source.x; })
        //  .attr("y1", function(d) { return d.source.y; })
        //  .attr("x2", function(d) { return d.target.x; })
        //  .attr("y2", function(d) { return d.target.y; });
         
         
          // 7.1 修改每条容器edge的位置
        edges.attr("transform", function (d) {
            return getTransform(d.source, d.target, getDis(d.source, d.target))
        });

        // // 7.2 修改每条线link位置
        links.attr("d", d=> {return "M" + 30 + "," + 0 + " L" + getDis(d.source, d.target) + ",0";})
    
});